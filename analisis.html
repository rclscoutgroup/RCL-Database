<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador RCL Scout Group v5 (Connected)</title>
    <style>
        :root {
            --primary: #0e2b4b;
            --secondary: #f0f2f5;
            --accent: #2c5282;
            --text: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--secondary);
            margin: 0;
            padding: 20px;
            color: var(--text);
        }

        /* --- REGLAS CR√çTICAS PARA IMPRESI√ìN (PDF) --- */
        @page {
            size: A4;
            margin: 1.5cm;
        }

        @media print {
            body, html {
                background-color: white !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .no-print, .btn-action, header.editor-header { display: none !important; }
            .print-only { display: block !important; }

            .container, #finalReport {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
            }

            .section-block-print { page-break-inside: avoid; margin-bottom: 20px; }
            h2, h3 { page-break-after: avoid; }
            img { max-width: 100% !important; height: auto; }
            a { text-decoration: none; color: var(--accent); font-weight: bold; }
            
            /* Ajustes espec√≠ficos para escudos en PDF */
            .team-crest-pdf { height: 50px !important; width: auto !important; vertical-align: middle; }
        }
        /* --------------------------------------------- */

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .print-only { display: none; }

        /* Header del Editor */
        header.editor-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        h1 { color: var(--primary); margin: 0; }
        h2 { color: var(--primary); margin-top: 30px; font-size: 1.2em; border-left: 5px solid var(--accent); padding-left: 10px; }
        h3 { color: var(--accent); font-size: 1.1em; margin-top: 15px; margin-bottom: 5px; }
        h4 { color: #555; font-size: 0.95em; margin-top: 10px; margin-bottom: 5px; font-style: italic; }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; font-size: 0.9em; margin-bottom: 5px; }
        input[type="text"], input[type="date"], select, textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        textarea { height: 80px; resize: vertical; font-family: inherit; }

        .row { display: flex; gap: 20px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 300px; }

        /* Estilos de Tabla */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px; 
            font-size: 0.9em; 
            table-layout: fixed; 
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
            overflow-wrap: break-word; 
        }
        th { background: var(--primary); color: white; }
        th.col-pos { width: 15%; text-align: center; }
        th.col-name { width: 35%; }

        /* Estilo Grid para Selectores */
        .style-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        .style-item label { font-size: 0.85em; color: #555; }
        .style-item select { font-size: 0.9em; padding: 5px; }

        /* Botones */
        .btn-action {
            display: block; width: 100%; padding: 15px;
            background: var(--primary); color: white; font-size: 1.1em;
            border: none; border-radius: 5px; cursor: pointer; margin-top: 30px;
            transition: background 0.3s;
        }
        .btn-action:hover { background: var(--accent); }

        /* ESTILOS DEL INFORME FINAL (PDF) */
        .report-header { 
            display: flex; justify-content: space-between; align-items: flex-start;
            border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-bottom: 20px; 
        }
        .report-logo { width: 120px; height: auto; object-fit: contain; }
        
        .match-score-box {
            display: flex; align-items: center; justify-content: center; gap: 20px;
            background: #f4f4f4; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #ddd;
        }
        .team-display { text-align: center; flex: 1; font-size: 18px; font-weight: bold; color: var(--primary); display: flex; flex-direction: column; align-items: center; gap: 5px;}
        .team-crest-pdf { height: 60px; width: auto; object-fit: contain; }
        .score-display { font-size: 32px; font-weight: bold; color: #333; padding: 0 20px; }

        .meta-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; 
            font-size: 0.95em; color: #444; margin-bottom: 25px; 
            border-bottom: 1px solid #eee; padding-bottom: 15px;
        }
        
        .video-link-box {
            margin-top: 5px; margin-bottom: 10px;
            padding: 5px 10px;
            background: #fff0f0; border-left: 4px solid #c4302b; 
            font-size: 0.85em; display: inline-block; border-radius: 4px;
        }
        
        .formation-display { display: flex; gap: 20px; margin-bottom: 25px; justify-content: space-between; }
        .formation-card { width: 48%; border: 1px solid #eee; padding: 5px; text-align: center; }
        .formation-card img { width: 100%; height: auto; max-height: 350px; object-fit: contain; }

        /* Estilo Tabla Estilo de Juego en PDF */
        .style-table-pdf td { padding: 4px 8px; border: none; border-bottom: 1px dotted #ccc; }
        .style-table-pdf tr:last-child td { border-bottom: none; }
        .style-label { font-weight: bold; color: var(--primary); width: 60%; }

    </style>
</head>
<body>

<div id="loginOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#0e2b4b; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; color:white;">
    <div style="background:white; padding:40px; border-radius:10px; text-align:center; color:#333; box-shadow:0 4px 15px rgba(0,0,0,0.5); width: 300px;">
        <h2 style="margin-top:0; color:#0e2b4b;">RCL SCOUT</h2>
        <p style="font-size:12px; color:#666;">Acceso Analista</p>
        
        <input type="email" id="loginEmail" placeholder="Usuario (Email)" style="display:block; width:100%; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:4px;">
        <input type="password" id="loginPass" placeholder="Contrase√±a" style="display:block; width:100%; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:4px;">
        
        <button onclick="iniciarSesion()" style="background:#28a745; color:white; border:none; padding:10px 20px; font-size:16px; border-radius:4px; cursor:pointer; width:100%; font-weight:bold;">ENTRAR</button>
        
        <p id="loginError" style="color:red; font-size:12px; margin-top:10px; display:none;">Error de credenciales</p>
    </div>
</div>
<div class="container" id="editorContainer">
    <header class="editor-header no-print">
        <h1>Generador RCL Scout Group v5</h1>
        <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; text-align: left; font-size: 0.9em; margin-top: 15px;">
            <ol>
                <li>Sube el Logo de RCL y los Escudos de los equipos.</li>
                <li>Rellena los datos (incluido el nuevo apartado de Estilo con selectores).</li>
                <li>Pega los enlaces de video donde corresponda (Generales o por Subapartado).</li>
                <li>Pulsa "Guardar" para subir a la nube y generar el PDF.</li>
            </ol>
            <div style="display:flex; gap:10px; align-items: center;">
                <label style="margin:0;">Logo RCL:</label>
                <input type="file" id="logoUpload" accept="image/*" onchange="previewImages('logoUpload', 'logoData')">
            </div>
        </div>
    </header>

    <div class="no-print">
        <h2>1. Detalles del Partido y Escudos</h2>
        <div class="row">
            <div class="col">
                <div class="input-group"><label>Fecha</label><input type="date" id="date"></div>
                <div class="input-group"><label>Competici√≥n</label><input type="text" id="competition" placeholder="Ej: 3¬™ RFEF"></div>
                <div class="input-group"><label>Estadio</label><input type="text" id="venue"></div>
            </div>
            <div class="col">
                <div class="input-group"><label>Equipo Local</label><input type="text" id="homeTeam"></div>
                <div class="input-group"><label>Escudo Local (PNG/JPG)</label><input type="file" id="crestHome" accept="image/*" onchange="previewImages('crestHome', 'homeCrestData')"></div>
                
                <div class="input-group"><label>Equipo Visitante</label><input type="text" id="awayTeam"></div>
                <div class="input-group"><label>Escudo Visitante (PNG/JPG)</label><input type="file" id="crestAway" accept="image/*" onchange="previewImages('crestAway', 'awayCrestData')"></div>
                
                <div class="input-group"><label>Resultado</label><input type="text" id="result" placeholder="0 - 0"></div>
                <div class="input-group"><label>Scout</label><input type="text" id="scout"></div>
            </div>
        </div>

        <h2>2. Formaciones (Im√°genes Pizarras)</h2>
        <div class="row">
            <div class="col"><label>Pizarra Local</label><input type="file" id="imgHome" accept="image/*" onchange="previewImages('imgHome', 'homeImgData')"></div>
            <div class="col"><label>Pizarra Visitante</label><input type="file" id="imgAway" accept="image/*" onchange="previewImages('imgAway', 'awayImgData')"></div>
        </div>

        <h2>3. Alineaci√≥n y Cambios</h2>
        <p style="font-size:0.8em; color:#666;">XI Inicial y Suplentes</p>
        <table id="lineupInput">
            <thead><tr>
                <th style="width:15%">Pos</th><th>Titular</th>
                <th style="width:15%">Pos</th><th>Suplente</th>
            </tr></thead>
            <tbody></tbody>
        </table>

        <p style="font-size:0.8em; color:#666; margin-top:20px;">Cambios / Sustituciones</p>
        <table id="subsInput">
            <thead><tr>
                <th style="width:15%">Minuto</th><th>Jugador Sale</th><th>Jugador Entra</th>
            </tr></thead>
            <tbody>
                </tbody>
        </table>

        <h2>4. An√°lisis T√°ctico</h2>
        <div id="analysisInputs"></div>

        <button class="btn-action" onclick="guardarYGenerar()">üíæ Guardar en Nube y Generar PDF</button>
    </div>
</div>

<div id="finalReport" class="container print-only" style="display:none;">
    <div class="report-header">
        <div style="max-width: 70%;">
            <h1 style="font-size: 24px; text-transform: uppercase; margin-bottom: 5px;">Informe de An√°lisis</h1>
            <div style="color:#666; font-size:14px;">RCL Scout Group &copy; 2025</div>
        </div>
        <img id="logoDisplay" src="" class="report-logo" alt="Logo RCL">
    </div>

    <div class="match-score-box">
        <div class="team-display">
            <img id="displayCrestHome" class="team-crest-pdf" src="" style="display:none;">
            <span id="displayHome">Local</span>
        </div>
        <div class="score-display" id="displayResult">0 - 0</div>
        <div class="team-display">
            <img id="displayCrestAway" class="team-crest-pdf" src="" style="display:none;">
            <span id="displayAway">Visitante</span>
        </div>
    </div>
    
    <div class="meta-grid" id="displayMeta"></div>

    <div id="displayFormations" class="formation-display"></div>

    <div id="displayLineup"></div>
    <div id="displaySubs"></div>

    <div id="displayAnalysis"></div>

    <div class="no-print" style="margin-top:50px; text-align: center; background: #fff; padding: 20px; border-top: 2px dashed #ccc;">
        <h3 style="margin-top:0">Vista Previa Generada</h3>
        <p>Si el contenido se ve bien aqu√≠, al exportar a PDF no se cortar√°.</p>
        <button class="btn-action" style="background: #28a745; width: auto; display: inline-block; padding: 12px 30px; margin: 5px;" onclick="window.print()">üñ®Ô∏è Imprimir / Guardar PDF</button>
        <button class="btn-action" style="background: #6c757d; width: auto; display: inline-block; padding: 12px 30px; margin: 5px;" onclick="editMode()">‚úèÔ∏è Volver a Editar</button>
    </div>
</div>

<script>
    // --- DATOS GLOBALES PARA IM√ÅGENES ---
    const images = {
        logoData: "", homeCrestData: "", awayCrestData: "",
        homeImgData: "", awayImgData: ""
    };

    // --- CONFIGURACI√ìN DE SECCIONES ---
    const sectionsConfig = [
        { 
            id: 'resumen', 
            title: 'Resumen del Partido', 
            type: 'simple', 
            subtitle: 'Visi√≥n general' 
        },
        { 
            id: 'estilo', 
            title: 'Estilo de Juego', 
            type: 'style_selector' // NUEVO TIPO
        },
        { 
            id: 'fase_ofensiva', 
            title: 'Fase Ofensiva', 
            type: 'complex', 
            subs: ['Zona Defensiva (Salida)', 'Zona Creaci√≥n', 'Zona Finalizaci√≥n'] 
        },
        { 
            id: 'fase_defensiva', 
            title: 'Fase Defensiva', 
            type: 'complex', 
            subs: ['Bloque Alto', 'Bloque Medio', 'Bloque Bajo'] 
        },
        { 
            id: 'transiciones', 
            title: 'Transiciones', 
            type: 'complex', 
            subs: ['Ofensiva (Def-Ata)', 'Defensiva (Ata-Def)'] 
        },
        { 
            id: 'abp', 
            title: 'ABP (Bal√≥n Parado)', 
            type: 'complex', 
            subs: ['ABP Ofensivo', 'ABP Defensivo'] 
        },
        { id: 'fortalezas', title: 'Fortalezas', type: 'simple', subtitle: 'Puntos Fuertes' },
        { id: 'debilidades', title: 'Debilidades', type: 'simple', subtitle: 'Puntos D√©biles' },
        { id: 'jugadores', title: 'Jugadores Destacados', type: 'simple', subtitle: 'An√°lisis Individual' }
    ];

    // --- OPCIONES PARA ESTILO DE JUEGO (SELECTOR) ---
    const styleOptions = [
        { label: "Estilo Ofensivo", options: ["-", "Indirecto/Combinativo", "Directo", "Contraataque"] },
        { label: "Estilo Defensivo", options: ["-", "Plegada", "Desplegada"] },
        { label: "Ataque - Ocupaci√≥n Amplitud", options: ["-", "Distancias cortas", "Amplios"] },
        { label: "Ataque - Ocupaci√≥n Profundidad", options: ["-", "Poco profundos", "Muy profundos"] },
        { label: "Ataque - Movilidad", options: ["-", "Posicionales", "Din√°micos"] },
        { label: "Ataque - Circulaci√≥n Bal√≥n", options: ["-", "Juego Interior", "Juego Exterior"] },
        { label: "Defensa - Actitud", options: ["-", "Presi√≥n", "Repliegue"] },
        { label: "Defensa - Zona Robo", options: ["-", "Interior", "Exterior"] },
        { label: "Defensa - Momento Robo", options: ["-", "Inmediato (Tras p√©rdida)", "Mediato (Organizado)"] }
    ];

    // --- INICIALIZACI√ìN DE LA INTERFAZ ---
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Tabla Alineaci√≥n (11 filas)
        const tbodyLineup = document.querySelector('#lineupInput tbody');
        for(let i=0; i<11; i++){
            tbodyLineup.innerHTML += `<tr>
                <td><input type="text" class="pos-start" style="width:100%"></td>
                <td><input type="text" class="name-start"></td>
                <td><input type="text" class="pos-sub" style="width:100%"></td>
                <td><input type="text" class="name-sub"></td>
            </tr>`;
        }

        // 2. Tabla Cambios (6 filas)
        const tbodySubs = document.querySelector('#subsInput tbody');
        for(let i=0; i<6; i++){
            tbodySubs.innerHTML += `<tr>
                <td><input type="text" class="sub-min" style="width:100%" placeholder="Min"></td>
                <td><input type="text" class="sub-out"></td>
                <td><input type="text" class="sub-in"></td>
            </tr>`;
        }

        // 3. Generar Secciones de An√°lisis
        const analysisContainer = document.getElementById('analysisInputs');
        
        sectionsConfig.forEach(sec => {
            let htmlContent = `<div class="section-block" style="background:#f9f9f9; padding:15px; border-radius:5px; margin-bottom:15px;">
                <h3 style="margin-top:0;">${sec.title}</h3>`;

            if(sec.type === 'simple') {
                htmlContent += `
                    <p style="font-size:0.8em; color:#666;">${sec.subtitle}</p>
                    <textarea id="txt_${sec.id}" placeholder="Escribe aqu√≠..."></textarea>
                    <div style="margin-top:5px;">
                        <label style="font-size:0.8em">Enlace V√≠deo:</label>
                        <input type="text" id="vid_${sec.id}" placeholder="URL del v√≠deo">
                    </div>
                `;
            } else if (sec.type === 'complex') {
                htmlContent += `
                    <div style="margin-bottom:15px; border-bottom:1px dashed #ccc; padding-bottom:10px;">
                        <label style="font-size:0.8em; color:var(--accent);">V√≠deo General de la Fase (Opcional):</label>
                        <input type="text" id="vid_gen_${sec.id}" placeholder="URL V√≠deo Completo de ${sec.title}">
                    </div>
                `;
                sec.subs.forEach((sub, index) => {
                    // ID √∫nico para cada subapartado: idseccion_index
                    htmlContent += `
                        <h4 style="margin-bottom:2px;">${sub}</h4>
                        <textarea id="txt_${sec.id}_${index}" style="height:60px;" placeholder="An√°lisis de ${sub}..."></textarea>
                        <div style="margin-bottom:10px;">
                            <input type="text" id="vid_${sec.id}_${index}" style="font-size:0.8em; padding:5px;" placeholder="Enlace V√≠deo Espec√≠fico ${sub}">
                        </div>
                    `;
                });
            } else if (sec.type === 'style_selector') {
                htmlContent += `<div class="style-grid">`;
                styleOptions.forEach((opt, idx) => {
                    let optionsHTML = opt.options.map(o => `<option value="${o}">${o}</option>`).join('');
                    htmlContent += `
                        <div class="style-item">
                            <label>${opt.label}</label>
                            <select id="style_opt_${idx}">${optionsHTML}</select>
                        </div>
                    `;
                });
                htmlContent += `</div>`;
            }

            htmlContent += `</div>`;
            analysisContainer.innerHTML += htmlContent;
        });
    });

    // --- MANEJO DE IM√ÅGENES ---
    const getBase64 = (file) => new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
    });

    async function previewImages(inputId, storageKey) {
        const file = document.getElementById(inputId).files[0];
        if(file) {
            images[storageKey] = await getBase64(file);
        }
    }

    // --- GENERAR REPORTE (Visual) ---
    async function generatePreview() {
        // 1. Datos B√°sicos
        const home = document.getElementById('homeTeam').value || 'Local';
        const away = document.getElementById('awayTeam').value || 'Visitante';
        const res = document.getElementById('result').value;
        
        // Logos y Escudos
        if(images.logoData) document.getElementById('logoDisplay').src = images.logoData;
        
        document.getElementById('displayHome').innerText = home;
        document.getElementById('displayAway').innerText = away;
        document.getElementById('displayResult').innerText = res;

        const crestHome = document.getElementById('displayCrestHome');
        const crestAway = document.getElementById('displayCrestAway');
        
        if(images.homeCrestData) { crestHome.src = images.homeCrestData; crestHome.style.display = 'inline'; }
        else crestHome.style.display = 'none';

        if(images.awayCrestData) { crestAway.src = images.awayCrestData; crestAway.style.display = 'inline'; }
        else crestAway.style.display = 'none';
        
        // Metadatos
        document.getElementById('displayMeta').innerHTML = `
            <div><strong>Fecha:</strong> ${document.getElementById('date').value}</div>
            <div><strong>Competici√≥n:</strong> ${document.getElementById('competition').value}</div>
            <div><strong>Estadio:</strong> ${document.getElementById('venue').value}</div>
            <div><strong>Scout:</strong> ${document.getElementById('scout').value}</div>
        `;

        // 2. Formaciones
        let formHTML = "";
        if(images.homeImgData) formHTML += `<div class="formation-card"><strong>${home}</strong><br><img src="${images.homeImgData}"></div>`;
        if(images.awayImgData) formHTML += `<div class="formation-card"><strong>${away}</strong><br><img src="${images.awayImgData}"></div>`;
        document.getElementById('displayFormations').innerHTML = formHTML;

        // 3. Alineaci√≥n
        let tableHTML = `<table style="width:100%; border-collapse:collapse; margin-bottom:10px; table-layout: fixed;">
            <thead><tr style="background:#0e2b4b; color:white;">
                <th class="col-pos">Pos</th><th class="col-name">XI Inicial</th>
                <th class="col-pos">Pos</th><th class="col-name">Suplentes</th>
            </tr></thead><tbody>`;
        
        let hasLineup = false;
        const rows = document.querySelectorAll('#lineupInput tbody tr');
        rows.forEach(r => {
            const p1 = r.querySelector('.pos-start').value;
            const n1 = r.querySelector('.name-start').value;
            const p2 = r.querySelector('.pos-sub').value;
            const n2 = r.querySelector('.name-sub').value;
            
            if(n1 || n2) {
                hasLineup = true;
                tableHTML += `<tr>
                    <td style="text-align:center;"><b>${p1}</b></td>
                    <td>${n1}</td>
                    <td style="text-align:center;"><b>${p2}</b></td>
                    <td>${n2}</td>
                </tr>`;
            }
        });
        tableHTML += "</tbody></table>";
        document.getElementById('displayLineup').innerHTML = hasLineup ? `<h3>Alineaciones</h3>${tableHTML}` : "";

        // 4. Cambios
        let subsHTML = `<table style="width:100%; border-collapse:collapse; margin-bottom:20px; table-layout: fixed;">
            <thead><tr style="background:#2c5282; color:white;">
                <th style="width:15%; text-align:center;">Min</th>
                <th style="color:#ffadad">Sale ‚¨á</th>
                <th style="color:#adffad">Entra ‚¨Ü</th>
            </tr></thead><tbody>`;
        
        let hasSubs = false;
        const subRows = document.querySelectorAll('#subsInput tbody tr');
        subRows.forEach(r => {
            const min = r.querySelector('.sub-min').value;
            const outP = r.querySelector('.sub-out').value;
            const inP = r.querySelector('.sub-in').value;
            if(min || outP || inP) {
                hasSubs = true;
                subsHTML += `<tr>
                    <td style="text-align:center; font-weight:bold;">${min}'</td>
                    <td>${outP}</td>
                    <td>${inP}</td>
                </tr>`;
            }
        });
        subsHTML += "</tbody></table>";
        document.getElementById('displaySubs').innerHTML = hasSubs ? `<h3>Cambios</h3>${subsHTML}` : "";


        // 5. An√°lisis T√°ctico
        let analysisHTML = "";
        
        sectionsConfig.forEach(sec => {
            // L√≥gica para 'simple'
            if(sec.type === 'simple') {
                const txt = document.getElementById(`txt_${sec.id}`).value;
                const vid = document.getElementById(`vid_${sec.id}`).value;
                if(!txt && !vid) return;

                let videoBlock = vid ? `<div class="video-link-box"><a href="${vid}" target="_blank">üì∫ Ver V√≠deo An√°lisis (${sec.title})</a></div>` : '';
                analysisHTML += `
                    <div class="section-block-print">
                        <h3 style="border-bottom: 1px solid #ccc;">${sec.title}</h3>
                        <div style="white-space: pre-wrap; line-height: 1.5; text-align: justify;">${txt}</div>
                        ${videoBlock}
                    </div>`;
            }
            // L√≥gica para 'style_selector' (Tabla limpia)
            else if (sec.type === 'style_selector') {
                // Verificar si hay al menos una opci√≥n seleccionada diferente a "-"
                let hasSelection = false;
                let styleTable = `<table class="style-table-pdf" style="width:100%;">`;
                styleOptions.forEach((opt, idx) => {
                    const val = document.getElementById(`style_opt_${idx}`).value;
                    if(val && val !== '-') {
                        hasSelection = true;
                        styleTable += `<tr><td class="style-label">${opt.label}</td><td>${val}</td></tr>`;
                    }
                });
                styleTable += `</table>`;
                
                if(hasSelection) {
                    analysisHTML += `<div class="section-block-print"><h3 style="border-bottom: 1px solid #ccc;">${sec.title}</h3>${styleTable}</div>`;
                }
            }
            // L√≥gica para 'complex' (Subapartados)
            else if (sec.type === 'complex') {
                const vidGen = document.getElementById(`vid_gen_${sec.id}`).value;
                let subContentHTML = "";
                
                // Primero vemos si hay video general
                if(vidGen) {
                    subContentHTML += `<div class="video-link-box" style="margin-bottom:15px;"><a href="${vidGen}" target="_blank">üì∫ Ver V√≠deo Completo: ${sec.title}</a></div>`;
                }

                // Iteramos subapartados
                let hasSubContent = false;
                sec.subs.forEach((sub, idx) => {
                    const txtSub = document.getElementById(`txt_${sec.id}_${idx}`).value;
                    const vidSub = document.getElementById(`vid_${sec.id}_${idx}`).value;
                    
                    if(txtSub || vidSub) {
                        hasSubContent = true;
                        let vidBlockSub = vidSub ? `<div class="video-link-box"><a href="${vidSub}" target="_blank">‚ñ∂ V√≠deo: ${sub}</a></div>` : '';
                        subContentHTML += `
                            <div style="margin-bottom: 15px;">
                                <h4 style="color:#0e2b4b; border-bottom:1px dotted #ccc; margin-bottom:5px;">${sub}</h4>
                                <div style="white-space: pre-wrap; margin-bottom:5px;">${txtSub}</div>
                                ${vidBlockSub}
                            </div>
                        `;
                    }
                });

                if(hasSubContent || vidGen) {
                    analysisHTML += `<div class="section-block-print"><h3 style="border-bottom: 1px solid #ccc;">${sec.title}</h3>${subContentHTML}</div>`;
                }
            }
        });

        document.getElementById('displayAnalysis').innerHTML = analysisHTML;

        // Mostrar Vista
        document.getElementById('editorContainer').style.display = 'none';
        document.getElementById('finalReport').style.display = 'block';
        window.scrollTo(0,0);
    }

    function editMode() {
        document.getElementById('editorContainer').style.display = 'block';
        document.getElementById('finalReport').style.display = 'none';
        window.scrollTo(0,0);
    }
</script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
    // 1. CONFIGURACI√ìN FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyDNqcD6XHJemD3lVSaJy98xADsqYSmfVSk",
        authDomain: "rcl-scout-group-database.firebaseapp.com",
        projectId: "rcl-scout-group-database",
        storageBucket: "rcl-scout-group-database.firebasestorage.app",
        messagingSenderId: "194052020832",
        appId: "1:194052020832:web:3de5ace09a814e98710105",
        measurementId: "G-M1P8P02CJT"
    };

    // Inicializar Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // 2. L√ìGICA DE LOGIN
    function iniciarSesion() {
        const email = document.getElementById('loginEmail').value;
        const pass = document.getElementById('loginPass').value;
        const errorMsg = document.getElementById('loginError');

        auth.signInWithEmailAndPassword(email, pass)
            .then((userCredential) => {
                document.getElementById('loginOverlay').style.display = 'none'; 
            })
            .catch((error) => {
                errorMsg.innerText = "Error: Email o contrase√±a incorrectos.";
                errorMsg.style.display = 'block';
            });
    }

    auth.onAuthStateChanged((user) => {
        if (user) {
            document.getElementById('loginOverlay').style.display = 'none';
        }
    });

    // 3. L√ìGICA DE GUARDADO COMPLEJO (Analista)
    function guardarYGenerar() {
        const user = auth.currentUser;
        if (!user) {
            alert("Debes iniciar sesi√≥n para guardar.");
            return;
        }

        const btn = document.querySelector('.btn-action');
        const txtOriginal = btn.innerText;
        btn.innerText = "Recopilando datos y subiendo...";
        btn.disabled = true;

        // A. Datos B√°sicos
        let informe = {
            tipo: "Analista",
            scout_email: user.email,
            fecha_registro: new Date(),
            fecha_partido: document.getElementById('date').value,
            competicion: document.getElementById('competition').value,
            estadio: document.getElementById('venue').value,
            local: document.getElementById('homeTeam').value,
            visitante: document.getElementById('awayTeam').value,
            resultado: document.getElementById('result').value,
            scout_name: document.getElementById('scout').value,
            analisis_tactico: {},
            alineaciones: [],
            cambios: []
        };

        // B. Recopilar Alineaciones (Solo filas con datos)
        const rows = document.querySelectorAll('#lineupInput tbody tr');
        rows.forEach(r => {
            const p1 = r.querySelector('.pos-start').value;
            const n1 = r.querySelector('.name-start').value;
            const p2 = r.querySelector('.pos-sub').value;
            const n2 = r.querySelector('.name-sub').value;
            if(n1 || n2) {
                informe.alineaciones.push({ pos_tit: p1, nom_tit: n1, pos_sup: p2, nom_sup: n2 });
            }
        });

        // C. Recopilar Cambios
        const subRows = document.querySelectorAll('#subsInput tbody tr');
        subRows.forEach(r => {
            const min = r.querySelector('.sub-min').value;
            const outP = r.querySelector('.sub-out').value;
            const inP = r.querySelector('.sub-in').value;
            if(min || outP || inP) {
                informe.cambios.push({ min: min, sale: outP, entra: inP });
            }
        });

        // D. Recopilar Secciones de An√°lisis (Usando sectionsConfig global)
        sectionsConfig.forEach(sec => {
            if(sec.type === 'simple') {
                const txt = document.getElementById(`txt_${sec.id}`).value;
                const vid = document.getElementById(`vid_${sec.id}`).value;
                informe.analisis_tactico[sec.id] = { texto: txt, video: vid };
            } 
            else if (sec.type === 'complex') {
                let subData = [];
                sec.subs.forEach((sub, idx) => {
                    const txtSub = document.getElementById(`txt_${sec.id}_${idx}`).value;
                    const vidSub = document.getElementById(`vid_${sec.id}_${idx}`).value;
                    subData.push({ subtitulo: sub, texto: txtSub, video: vidSub });
                });
                const vidGen = document.getElementById(`vid_gen_${sec.id}`).value;
                informe.analisis_tactico[sec.id] = { video_general: vidGen, apartados: subData };
            }
            else if (sec.type === 'style_selector') {
                let styles = [];
                styleOptions.forEach((opt, idx) => {
                    const val = document.getElementById(`style_opt_${idx}`).value;
                    styles.push({ label: opt.label, valor: val });
                });
                informe.analisis_tactico[sec.id] = styles;
            }
        });

        // E. Guardar en Firestore
        db.collection("informes_analista").add(informe)
            .then((docRef) => {
                alert("‚úÖ Informe de An√°lisis guardado correctamente.");
                generatePreview(); // Llama a la funci√≥n visual original
            })
            .catch((error) => {
                alert("‚ùå Error al guardar: " + error.message);
            })
            .finally(() => {
                btn.innerText = txtOriginal;
                btn.disabled = false;
            });
    }
</script>

</body>
</html>